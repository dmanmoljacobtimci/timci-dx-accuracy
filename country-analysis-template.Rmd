---
title: "Country Analysis Template"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: TRUE
    toc_float: TRUE
    theme: journal
---

## Background

The overall goal of this project is to reduce morbidity and mortality of sick children attending primary care facilities while supporting the rational and efficient use of diagnostics and medicines by healthcare providers. This study is focused on generating evidence for pulse oximetry and clinical decision support algorithms (CDSAs) in primary care. To determine the performance of the multimodal PO devices under investigation in this study, a cross-sectional diagnostic accuracy study will compare the index multimodal PO devices to an accepted reference standard.

The primary objective of this study is to determine the performance of available multimodal PO devices compared to an accepted reference standard by primary care providers assessing chidlren 0-59 months seeking care at the primary care level. Reference standards for the different clinical measurements include: Masimo Rad97 patient monitor (SpO2, PR), video derived annotated respiratory rate (RR), and digital infrared thermometer (temp). Secondary objectives include determining if any variability in performance is detected by age category or skin pigmentation and assessing interrater reliability.

## Using this document

(agreed upon conventions)

```{r setup, include=FALSE}
rm(list = ls())
# install these packages if not already on your computer
library(plyr)
library(dplyr)
library(tableone)
library(kableExtra)
library(BlandAltmanLeh)
library(irr)

# Read in (cleaned) data using file choose
filename <- file.choose()
df_og <- read.csv(filename)
df_og <- df_og %>% select(-c("X"))

# Define country and subset
COUNTRY <- "Kenya" # Kenya, Tanzania, India -- USER INPUT HERE
df_og <- subset(df_og, df_og$country==COUNTRY)

# Define thresholds for hypoxia, fast breathing, tachycardia, and fever for all index and reference measurements (for confusion matrices in section 5) -- should be binary indicators for above/below threshold

# Create a df for each device -- note: any variable formatting (e.g., converting to factors) or additional variable creation should happen prior to creating these little dataframes
df_radg <- subset(df_og, index_device_name=="Rad-G Temp (Masimo)")
df_bio <- subset(df_og, index_device_name=="m800 (Biolight)")
df_neo <- subset(df_og, index_device_name=="NeoGuard (Neopenda)")
df_onyx <- subset(df_og, index_device_name=="Onyx PO+RR (Nonin)")
df_scan <- subset(df_og, index_device_name=="Scanbo v8 (Scanbo)")
```

This report contains data from `r COUNTRY`.

# Section 1: Participant Characteristics {.tabset}
Leila
Table 1: Participant Characteristics Overall and by Facility
```{r echo=FALSE, include=FALSE}
# consider using the CreateTableOne function from the tableone package, example:
## Define row labels (optional): t1lab <- c("N", "Age category", "Sex = Male (%)", ...)
## Define all variables: vars <- c("age_cat2", "sex", ...)
## Define the variables you want it to treat as factors (useful if they could be perceived as continuous): fvar <- c("age_cat2", sex", ...)

## create the tableone object: out1 <- CreateTableOne(vars = vars,
#                                       factorVars = fvar,
#                                       strata = "health_facility",
#                                       data = df)
# print as table: t1 <- print(out1)
# assign rownames defined above (optional - would recommend only doing this once the rows are set so you know what each one is): rownames(t1) <- c(t1lab)

# kable formatting if you want to get fancy: 
#  t1 <- kable(out1) %>%
#  kable_styling(position = "center") %>%
#  add_indent(c(3:5))
```
`r t1`

# Section 2: Measurement Characteristics & Precision {.tabset}
Leila

## Reference
```{r echo=FALSE, include=FALSE}

```

## Rad-G Temp (Masimo)


## m800 (Biolight)


## NeoGuard (Neopenda)


## Onyx PO+RR (Nonin)


## Scanbo v8 (Scanbo)


# Section 3: Bland Altman Plots {.tabset}

-- RG Note: let's see if we can find a way to get M1, M2, and M3 all on the same plot and perhaps distinguish them by color?
Example code:
```{r}
# Default subtraction is grp1 - grp2 --> place reference first, test second
#bland.altman.plot(df$reference, df$index, graph.sys = "ggplot2") + labs(title = "Bland-Altman Plot: [specify measurement and age group]") + xlab("Means") + ylab("Differences") + theme(plot.title = element_text(hjust = 0.5))
```

## Rad-G Temp (Masimo) {.tabset}
```{r echo=FALSE, include=FALSE}

```

### Temperature

### Oxygen

### Profusion Index

### Pulse Rate

### Respiratory Rate -- this will only have one plot per age group using the matched index measurement to what was annotated

## m800 (Biolight) {.tabset}
```{r echo=FALSE, include=FALSE}

```

### Oxygen

### Pulse Rate

### Respiratory Rate -- this will only have one plot per age group using the matched index measurement to what was annotated

## NeoGuard (Neopenda) {.tabset}
```{r echo=FALSE, include=FALSE}

```

### Temperature

### Oxygen

### Pulse Rate

### Respiratory Rate -- this will only have one plot per age group using the matched index measurement to what was annotated

## Onyx PO+RR (Nonin) {.tabset}
```{r echo=FALSE, include=FALSE}
df <- df_onyx
```

## Scanbo v8 (Scanbo) {.tabset}
```{r echo=FALSE, include=FALSE}

```

### Temperature

### Oxygen

### Pulse Rate

### Respiratory Rate -- this will only have one plot per age group using the matched index measurement to what was annotated

# Section 4: Intraclass Correlation Coefficients {.tabset}
Rebecca

# Section 5: Confusion Matrices {.tabset}
Samwel
5 & 6 should be done by same person
```{r echo=FALSE, include=FALSE}
# key functions: irr::agree, addmargins(table()), prop.table
```

## Rad-G Temp (Masimo)


## m800 (Biolight)


## NeoGuard (Neopenda)


## Onyx PO+RR (Nonin)


## Scanbo v8 (Scanbo)

# Section 6: Percent Agreement {.tabset}

